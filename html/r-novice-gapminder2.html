<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>R Novice Gapminder</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="notes.css" type="text/css" />
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
</head>
<body>
<div id="header">
<h1 class="title">R Novice Gapminder</h1>
<h1 class="subtitle">R for Reproducible Scientific Analysis Part 2</h1>
</div>
<h2 id="pre-workshop-setup">Pre-Workshop Setup</h2>
<ul>
<li>Load the gapminder dataset
<ul>
<li>Make a new R file</li>
<li><code>gap &lt;- read.csv(&quot;data/gapminder_data.csv&quot;)</code></li>
</ul></li>
<li>Install packages
<ul>
<li><p><span></span></p>
<pre><code>install.packages(c(&quot;ggplot2&quot;, &quot;cowplot&quot;, &quot;tidyr&quot;, &quot;dplyr&quot;, 
    &quot;knitr&quot;, &quot;rmarkdown&quot;, &quot;formatR&quot;))</code></pre></li>
</ul></li>
</ul>
<h3 id="open-up-socrative-again">Open up Socrative again</h3>
<ul>
<li>You can import my quiz with SOC-26147790</li>
<li>Advise learners to go to <a href="https://b.socrative.com/login/student/" class="uri">https://b.socrative.com/login/student/</a></li>
<li><p>Type in MICKLEY for the room name</p></li>
<li>So far, we've just had R do exactly what we told it to do.<br />
</li>
<li>It becomes much more powerful if it can make its own decisions or do repetitive tasks</li>
<li>We're going to learn conditional statements, functions, and loops that will do just that
<ul>
<li>These same concepts get used in most other computer languages =&gt; portable skills.</li>
<li>We already saw loops in shell, which actually has functions and conditionals too</li>
</ul></li>
</ul>
<h2 id="a.-vectorization-5-minutes">1a. Vectorization (5 minutes)</h2>
<ul>
<li>One reason why R is used so much for data analysis is that it has a neat feature</li>
<li>Most functions are &quot;vectorized&quot;, meaning they'll operate on a whole list of numbers at once</li>
<li>Here x is a vector of four numbers
<ul>
<li><p><span></span></p>
<pre><code>x &lt;- 1:4
x
x * 2</code></pre></li>
</ul></li>
<li>What happens if we add two vectors together</li>
<li>Explain on the board what is going on
<ul>
<li><p><span></span></p>
<pre><code>y &lt;- 6:9
x + y</code></pre></li>
</ul></li>
<li>This also works for comparison operators, logical operators, or functions
<ul>
<li><p><span></span></p>
<pre><code>x &gt; 2

a &lt;- x &lt; 2
b &lt;- x &gt; 3

a | b

log(x)</code></pre></li>
</ul></li>
<li><strong>Note:</strong>
<ul>
<li>The <code>*</code> operator etc gives you element-wise multiplication</li>
<li><p>For matrix multiplication you need to use %*%</p></li>
<li><p><span></span></p>
<pre><code>m &lt;- matrix(1:12, nrow=3, ncol=4)
m * -1

m * m

m %*% matrix(1, nrow=4, ncol=1)
</code></pre></li>
</ul></li>
</ul>
<h2 id="conditional-statements-25-minutes">1. Conditional Statements (25 minutes)</h2>
<ul>
<li>Often when coding, we want to control what happens in certain situations</li>
<li>We'll start with making choices using <em>conditional statements</em>
<ul>
<li><p><span></span></p>
<pre><code>number &lt;- 37
if (number &gt; 100) {
    print(&quot;greater than 100&quot;)
} else {
    print(&quot;less than 100&quot;)
}
print(&quot;Finished checking&quot;)</code></pre></li>
</ul></li>
<li>Walk through this example, showing the flow
<ul>
<li>Draw choice diagram</li>
</ul></li>
<li>Comparison operators
<ul>
<li>Greater than: <code>number &gt; 100</code></li>
<li>Less than: <code>number &lt; 100</code></li>
<li>Equal to: <code>number == 37</code></li>
<li>Not equal to: <code>number != 37</code></li>
<li>Also =&gt; and &lt;=</li>
</ul></li>
<li>We don't need an else:
<ul>
<li><p><span></span></p>
<pre><code>if (number &gt; 100) {
    print(&quot;greater than 100&quot;)
}</code></pre></li>
</ul></li>
<li>We could have more than one test, test the sign of the number
<ul>
<li><p><span></span></p>
<pre><code>number = -3
if (number &gt; 0) {
     print(1)
} else if (number &lt; 0) {
     print(-1)
} else {
     print(0)
}</code></pre></li>
</ul></li>
<li>We can combine tests with logical operators
<ul>
<li><p><span></span></p>
<pre><code>number1 = 15
number2 = 40

if (number1 &gt;= 0 &amp; number2 &gt;= 0) {
    print(&quot;Both numbers are positive&quot;)
} else {
    print(&quot;At least one number is negative&quot;)
}

if (number1 &gt;= 0 | number2 &gt;= 0) {
    print(&quot;At least one number is not negative&quot;)
} else {
    print(&quot;Both numbers are negative&quot;)
}</code></pre></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #1 ----------</em></strong>: Test whether number is between 45 and 50 (inclusive)</p>
<p>This is a tricky one, 3 correct answers</p>
<h2 id="loops-40-minutes">2. Loops (40 minutes)</h2>
<ul>
<li>Just like the shell, R has for loops, which can do repetitive tasks</li>
<li>But the syntax is slightly different
<ul>
<li><p><span></span></p>
<pre><code>numbers &lt;- c(1:10)
print(numbers)
for (number in numbers) {
     print(number)
}

for(i in 1:5){
    print(numbers[i])
}</code></pre></li>
</ul></li>
<li>Walk through this again
<ul>
<li>i is an <em>increment variable</em>, keeps track of where we are</li>
<li><code>1:10</code> returns a sequence</li>
</ul></li>
<li>The loop or increment variable is just a variable.<br />
</li>
<li>Overwrites previous variable, and when the loop finishes, it's the last loop</li>
<li><p><span></span></p>
<pre><code>letter &lt;- &quot;z&quot;
print(letter)
for (letter in c(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)) {
    print(letter)
}
print(letter)</code></pre></li>
</ul>
<p><strong><em>---------- Socrative #2 ----------</em></strong>: For loop to calculate sum of vector</p>
<ul>
<li><p><span></span></p>
<pre><code>numbers &lt;- c(4, 8, 15, 16, 23, 42)
running_sum = 0
for (number in numbers) {
     running_sum = running_sum + number
}
print(running_sum)</code></pre></li>
<li>The loop variable can be useful to us
<ul>
<li><p><span></span></p>
<pre><code>for(i in 1:10){
    print(gap$year[i])
}</code></pre></li>
<li><p>Instead of 10, I could use <code>nrow(gap)</code></p></li>
</ul></li>
</ul>
<h3 id="nesting-for-loops">Nesting For loops</h3>
<ul>
<li>For loops can also be nested
<ul>
<li><p><span></span></p>
<pre><code># First for loop
for(i in 1:3){

    # Second for loop
    for(j in c(&#39;a&#39;, &#39;b&#39;, &#39;c&#39;)){
        print(paste(i, j))
    } # End of second

} # End of first</code></pre></li>
<li><p>Gives me every combination. Notice the order of nesting matters</p></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #3 ----------</em></strong>: For loop to find years with life expectancy &lt; 35</p>
<ul>
<li><p><span></span></p>
<pre><code>for (i in 1:10) {
     if (gap$lifeExp[i] &lt; 35) {
          print(gap$year[i])
     }
}</code></pre></li>
<li>We could extend this to the whole dataset, and have it tell us the country too
<ul>
<li><p><span></span></p>
<pre><code>for (i in 1:nrow(gap)) {
     if (gap$lifeExp[i] &lt; 35) {
          print(paste(gap$country[i], gap$year[i]))
     }
}</code></pre></li>
</ul></li>
</ul>
<h3 id="while-loops-5-minutes-optional">While Loops (5 minutes, optional)</h3>
<ul>
<li>Sometimes we need to just keep doing something until a certain condition is met</li>
<li><p>Break R with a While loop, stop the script</p>
<ul>
<li><p><span></span></p>
<pre><code>z &lt;- 1
while (z &gt; 0.1) {
    print(z)
}</code></pre></li>
</ul></li>
<li>Let's fix it by updating z, so it has a chance to quit
<ul>
<li><code>runif()</code> is used to pick a random number between zero and 1</li>
<li><p><span></span></p>
<pre><code>runif(1)
z &lt;- 1
while (z &gt; 0.1) {
    z &lt;- runif(1)
    print(z)
}</code></pre></li>
</ul></li>
</ul>
<h2 id="creating-and-using-functions-30-minutes">3. Creating and using functions (30 minutes)</h2>
<p><strong>QUESTION: How many of you end up doing the same thing more than once while analyzing your data?</strong></p>
<ul>
<li>Functions package a bit of code we want to re-use so that we don't have to re-write it or remember how it works later</li>
<li>Almost like little programs in the shell</li>
<li>Often, the function will take some variables as arguments and return something back to us (but doesn't have to)</li>
<li>We've actually been using them all along!
<ul>
<li><code>read.csv()</code> is a function. We give it a filename and it gives us a dataframe</li>
<li>Do any of you know what it actually does?</li>
<li>Show that we can actually see the code (wrapper for read.table())</li>
</ul></li>
<li><p><span></span></p>
<pre><code>fahr_to_kelvin &lt;- function(temp) {
    kelvin &lt;- ((temp - 32) * (5 / 9)) + 273.15
    return(kelvin)
}

# Without running previous code: 
fahr_to_kelvin(32)</code></pre></li>
<li>Function code must be run before it's called</li>
<li>Freezing point
<ul>
<li><code>fahr_to_kelvin(32)</code></li>
</ul></li>
<li>Boiling point
<ul>
<li><code>fahr_to_kelvin(212)</code></li>
</ul></li>
<li>We can make another function to convert to Celsius
<ul>
<li><p><span></span></p>
<pre><code>kelvin_to_celsius &lt;- function(temp) {
    celsius &lt;- temp - 273.15
    return(celsius)
}

kelvin_to_celsius(0)</code></pre></li>
</ul></li>
<li>Variable Scope: Variables defined inside functions stay there, a function is it's own little box/environment</li>
<li>Pass-by-Value: Functions don't change the variables we give them either (usually), we work on a copy. Safer!
<ul>
<li><code>print(celsius)</code></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #4 ----------</em></strong>: Testing variable scope</p>
<p>Both B and D are correct.</p>
<ul>
<li><p>Defensive programming: notice how we used a different name for the output of the function = better</p></li>
<li>We can mix, match and combine functions with themselves to get larger chunks of code
<ul>
<li><p><span></span></p>
<pre><code>fahr_to_celsius &lt;- function(temp) {
    temp_k &lt;- fahr_to_kelvin(temp)
    temp_c &lt;- kelvin_to_celsius(temp_k)
    return(temp_c)
}

# freezing point of water in Celsius
fahr_to_celsius(32.0)</code></pre></li>
</ul></li>
<li>Another way to do this would be to nest the first two functions together (walk through this)
<ul>
<li><code>kelvin_to_celsius(fahr_to_kelvin(32.0))</code></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #4 ----------</em></strong>: Write a C to F function</p>
<ul>
<li><p><span></span></p>
<pre><code>celsius_to_fahr &lt;- function(temp){
  fahr &lt;- temp * 9 / 5 + 32
  return(fahr)
}

celsius_to_fahr(100)</code></pre></li>
</ul>
<h3 id="function-challenge">Function Challenge</h3>
<p>Now write a function that takes two arguments: one the temp to be converted, and another that says whether to convert from fahrenheit to celsius or celsius to fahrenheit. Using if...then, make the same function do both.</p>
<ul>
<li><code>tempconvert(temp = 14, to = &quot;fahrenheit&quot;)</code>
<ul>
<li><p><span></span></p>
<pre><code>tempconvert &lt;- function(temp, to) {
     if (to == &quot;fahrenheit&quot;) {
          converted = temp * 9 / 5 + 32
     } else if (to == &quot;celsius&quot;) {
          converted = (temp - 32) * (5 / 9)
     }
     return(converted)
}

tempconvert(100, &quot;fahrenheit&quot;)
tempconvert(212, &quot;celsius&quot;)</code></pre></li>
</ul></li>
<li>What happens if we capitalize celsius?: <code>tempconvert(212, &quot;Celsius&quot;)</code>
<ul>
<li>Good idea to try to forsee ways that things might break</li>
<li><p>adding an &quot;else&quot; is a good idea:</p>
<ul>
<li><p><span></span></p>
<pre><code>else {
    converted = NA
    print(&quot;Error: &#39;to&#39; was not fahrenheit or celsius&quot;)
}</code></pre></li>
</ul></li>
<li>Note that we need to re-run the function code for the changes to take effect!</li>
</ul></li>
<li>When you write a function like this, you often don't use it again until months later.<br />
</li>
<li>Or someone else needs to use it.
<ul>
<li>So it's a good idea to add documentation!
<ol style="list-style-type: decimal">
<li>What does the function do?<br />
</li>
<li>What are it's arguments?</li>
<li>What does it return?</li>
</ol></li>
</ul></li>
<li>We can also add a default value for some of the arguments, so we don't need to include them unless we want to
<ul>
<li><p><span></span></p>
<pre><code>tempconvert &lt;- function(temp, to = &quot;celsius&quot;) {
    # Converts a temperature from celsius to fahrenheit
    #   or from fahrenheit to celsius.
    # Takes a temperature and the desired unit as arguments
    # Returns the converted temperature
    # Example: tempconvert(212, &quot;celsius&quot;) =&gt; 100

tempconvert(212)</code></pre></li>
</ul></li>
</ul>
<h3 id="advanced-functions">Advanced Functions</h3>
<ul>
<li>Make a function that calculates gdp of a nation from gapminder
<ul>
<li>Function should take a dataset with pop and gdpPercap columns and return a vector of gdps</li>
<li><p><span></span></p>
<pre><code># Takes a dataset and multiplies the population column
# with the GDP per capita column.
calcGDP &lt;- function(dat) {
  gdp &lt;- dat$pop * dat$gdpPercap
  return(gdp)
}

calcGDP(head(gapminder))</code></pre></li>
</ul></li>
<li>A more useful version edits the dataset
<ul>
<li><p><span></span></p>
<pre><code>calcGDP &lt;- function(dat, year=NULL, country=NULL) {
  if(!is.null(year)) {
    dat &lt;- dat[dat$year %in% year, ]
  }
  if (!is.null(country)) {
    dat &lt;- dat[dat$country %in% country,]
  }
  gdp &lt;- dat$pop * dat$gdpPercap
  new &lt;- cbind(dat, gdp=gdp)
  return(new)
}

head(calcGDP(gapminder, year=2007))

calcGDP(gapminder, country=&quot;Australia&quot;)
</code></pre></li>
</ul></li>
<li>Lots going on here
<ul>
<li>Optional arguments</li>
<li>Checking arguments and defensive programming</li>
<li>Subsetting the dataset</li>
<li>Adding a column with cbind</li>
</ul></li>
</ul>
<h2 id="subsetting-and-reshaping-data-with-dplyr-and-tidyr">4. Subsetting and reshaping data with dplyr and tidyr</h2>
<ul>
<li>Now we're going to switch gears!</li>
<li>We have a grasp of basic programming in R</li>
<li>Most of our work here is 3 things: data wrangling, graphs, and analyses</li>
<li><p>We'll cover the first two, since the same stuff applies to everyone</p></li>
<li>The subsetting and data-wrangling tools bundled with R are not the best</li>
<li><p>We're going to use dplyr and tidyr instead.</p></li>
</ul>
<h3 id="dplyr">dplyr</h3>
<ul>
<li>Setup</li>
<li>Install packages
<ul>
<li><code>install.packages(c(&quot;tidyr&quot;, &quot;dplyr&quot;, &quot;knitr&quot;, &quot;rmarkdown&quot;, &quot;formatR&quot;))</code></li>
<li><code>library(dplyr)</code></li>
</ul></li>
<li>Select lets you only use some columns. You can also re-order them
<ul>
<li><p><span></span></p>
<pre><code>head(gap)
yr_country_gdp &lt;- select(gap, year, country, gdpPercap)
head(year_country_gdp)</code></pre></li>
</ul></li>
<li><p>Select lets us subset columns, but what if we want to subset rows? filter() does that</p>
<ul>
<li><p><span></span></p>
<pre><code>str(gap)
gap_eu &lt;- filter(gap, continent == &quot;Europe&quot;)
str(gap_eu)</code></pre></li>
</ul></li>
<li><p>We can stack these functions to do both</p>
<ul>
<li><p><span></span></p>
<pre><code>yr_country_gdp_eu &lt;- filter(select(gap, year, country, gdpPercap), 
    continent==&quot;Europe&quot;)</code></pre></li>
</ul></li>
<li>This stacking can quickly become difficult to read, we really want a workflow that's easy to follow
<ul>
<li>dplyr also can use an R version of pipes, like what we saw in the shell lesson
<ul>
<li><code>yr_country_gdp &lt;- gap %&gt;% select(year, country, gdpPercap)</code></li>
<li>You don't have to bother giving it the data argument anymore. Easier to read</li>
</ul></li>
<li><p><span></span></p>
<pre><code>yr_country_gdp_eu &lt;- gap %&gt;%
    filter(continent==&quot;Europe&quot;) %&gt;%
    select(year,country,gdpPercap)</code></pre></li>
<li><p>Walk through this example, showing the flow</p></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #1 ----------</em></strong>: Filter using 2 filters and select 3 cols</p>
<p>Write a command with pipes that filters the gapminder dataset to only include data from 2007 in Africa, and then select the year, country, and lifeExp columns.</p>
<p>How many rows are left in the resulting dataset? If you're not sure how to find the number of rows, discuss with your neighbors.</p>
<ul>
<li><p><span></span></p>
<pre><code>africa_07_lifeExp %
    filter(continent == &quot;Africa&quot;) %&gt;% 
    filter(year == 2007) %&gt;%
    select(year, country, lifeExp)

nrow(africa_07_lifeExp)

africa_07_lifeExp %
    filter(continent == &quot;Africa&quot;, year == 2007) %&gt;% 
    select(year, country, lifeExp)

str(africa_07_lifeExp)</code></pre>
<ul>
<li>Note that the order is really important! Since select removes continent, it has to come second</li>
<li>We could have used two filter commands instead</li>
</ul></li>
<li>Summarize lets us condense data down
<ul>
<li><code>mean_gdp &lt;- gap %&gt;% summarize(meanGDP = mean(gdpPercap))</code></li>
</ul></li>
<li>Not very useful by itself, we could have used this instead
<ul>
<li><code>mean(gap$gdpPercap)</code></li>
</ul></li>
<li>But if we combine it with the group_by() function, we can get the mean gdp for each continent
<ul>
<li><p><span></span></p>
<pre><code>gdp_by_cont &lt;- gap %&gt;%
    group_by(continent) %&gt;%
    summarize(mean_gdp = mean(gdpPercap))

gdp_by_cont</code></pre></li>
</ul></li>
<li><p>Here we're grouping by continent, which means we calculate a <strong>separate</strong> mean for each one</p></li>
</ul>
<p><strong><em>---------- Socrative #2 ----------</em></strong>: Avg lifeExp by year for Africa</p>
<p>Let's compute the average life expectancy across all African countries by year. In how many years did average African life expectancy decrease?</p>
<ul>
<li><p><span></span></p>
<pre><code>africa_lifeExp_yr &lt;- gap %&gt;%
    filter(continent == &quot;Africa&quot;) %&gt;%
    group_by(year) %&gt;%
    summarize(avg_life = mean(lifeExp))

africa_lifeExp_yr</code></pre></li>
<li><p>What if we wanted to create a new column for gdp per billion people w/o condensing our data down? Use mutate()</p>
<ul>
<li><p><span></span></p>
<pre><code>bill_gdp_country_07 &lt;- gap %&gt;%
    filter(year == 2007) %&gt;%
    mutate(billion_gdp = gdpPercap * pop / 10^9) %&gt;%
    select(continent, country, billion_gdp)

head(bill_gdp_country_07)</code></pre></li>
</ul></li>
<li><p>We can group multiple variables and summarize multiple things</p>
<ul>
<li><p><span></span></p>
<pre><code>gdp_by_cont &lt;- gap %&gt;%
    group_by(continent, year) %&gt;%
    summarize(mean_gdp = mean(gdpPercap), 
        sd_gdp = sd(gdpPercap), 
        mean_pop = mean(pop), 
        sample_size = n(),
        se_gdp = sd_gdp / sqrt(sample_size))

gdp_by_cont</code></pre></li>
<li>n() is a special function that gives the sample size for that grouping, very useful</li>
<li>Notice that we only see 10 rows. Summarize actually has returned a &quot;special&quot; table-dataframe</li>
<li>In most cases it acts the same, but if we want to see the whole thing, we can pipe it to data.frame()
<ul>
<li><code>gdp_by_continents %&gt;% data.frame()</code></li>
</ul></li>
</ul></li>
<li><p>We can combine dplyr and ggplot2</p>
<ul>
<li><p><span></span></p>
<pre><code>gap %&gt;% filter(continent == &quot;Americas&quot;) %&gt;%
    ggplot(aes(x = year, y = lifeExp, color = country)) + 
    geom_line() + 
    geom_point()</code></pre></li>
</ul></li>
<li>One of the reasons we like dplyr so much, is there's not a lot to remember.
<ul>
<li>Most of your work can be done with the 5 functions we just learned
<ul>
<li><code>select(), filter(), group_by(), summarize(), and mutate()</code></li>
</ul></li>
</ul></li>
</ul>
<h3 id="tidyr">tidyr</h3>
<ul>
<li>Setup
<ul>
<li><code>install.packages(&quot;tidyr&quot;)</code></li>
<li><code>library(tidyr)</code></li>
</ul></li>
<li>The same dataset can be represented in different ways</li>
<li>Wide format:
<ul>
<li><p><span></span></p>
<pre><code>Genus   Weight  Length
Ursus   122     82
Felis   5       14</code></pre></li>
</ul></li>
<li>Long format:
<ul>
<li><p><span></span></p>
<pre><code>Genus   Measurement     Value
Ursus   Weight          122
Ursus   Length          82
Felis   Weight          5
Felis   Length          14</code></pre></li>
</ul></li>
<li>In long format, each column is a variable and each row is a single measurement or observation</li>
<li>We tend to use wide format more because it's more concise, easy to ready, datasheety</li>
<li>R, databases, and other programming languages usually prefer long format</li>
</ul>
<p><strong><em>---------- Socrative #3 ----------</em></strong>: What format is the gap dataset</p>
<p>Answer: intermediate</p>
<ul>
<li>We could have a column for each year * pop/lifeExp/gdpPerCap</li>
<li>We have 3 ID columns (country, continent, year), and 3 observation columns (gdpPercap, lifeExp, pop) (instead of 1)
<ul>
<li>Important to be able to convert, some R tools need specific format</li>
</ul></li>
<li><p><span></span></p>
<pre><code>gap_wide &lt;- read.csv(&quot;data/gapminder_wide.csv&quot;, stringsAsFactors = FALSE)
str(gap_wide)</code></pre>
<ul>
<li>So this is the wide format of our data</li>
<li>Notice it's got lots of columns and only 142 rows, one for each country</li>
</ul></li>
<li><p>We're going to convert it to long format with gather()</p>
<ul>
<li><p><span></span></p>
<pre><code>gap_long &lt;- gap_wide %&gt;%
     gather(obstype_year, obs_values, starts_with(&#39;pop&#39;),
            starts_with(&#39;lifeExp&#39;), starts_with(&#39;gdpPercap&#39;))
str(gap_long)
head(gap_long)</code></pre></li>
</ul></li>
<li>Notice how we've mixed dplyr pipes with the gather() function from tidyr</li>
<li>The first two arguments are new column names: The old column name goes in 1st &amp; value in 2nd</li>
<li>Instead of using starts_with(), we could have just written out all the columns we wanted to gather</li>
<li><p>We could also just exclude the columns we don't want to gather</p>
<ul>
<li><p><span></span></p>
<pre><code>gap_long &lt;- gap_wide %&gt;% 
    gather(obstype_year, obs_values, -continent, -country)
str(gap_long)</code></pre></li>
</ul></li>
<li>Our new column obstype_year actually has 2 pieces of information. We should separate them
<ul>
<li><p><span></span></p>
<pre><code>gap_long &lt;- gap_long %&gt;% 
     separate(obstype_year, into = c(&#39;obs_type&#39;, &#39;year&#39;), sep = &quot;_&quot;) %&gt;%
     mutate(year = as.integer(year))</code></pre></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #4 ----------</em></strong>: Use dplyr on the long dataset</p>
<p>Using gap_long, summarize the mean life expectancy by continent</p>
<ul>
<li><p><span></span></p>
<pre><code>gap_long %&gt;%
    filter(obs_type == &quot;lifeExp&quot;) %&gt;%
    group_by(continent) %&gt;%
    summarize(lifeExp = mean(obs_values))</code></pre></li>
<li>Now that we have our long format, let's convert it to the intermediate format
<ul>
<li><p><span></span></p>
<pre><code>gap_normal &lt;- gap_long %&gt;% 
    spread(obs_type, obs_values)
head(gap_normal)
dim(gap_normal)
dim(gap)</code></pre></li>
</ul></li>
<li>Notice how the contents of obs_type became the column names</li>
<li>Looks like the same dataset, cool, we're back</li>
<li>Columns are in a different order though, let's fix that
<ul>
<li><p><span></span></p>
<pre><code>names(gap_normal)
names(gap)
gap_normal &lt;- gap_normal %&gt;%
    select(country, year, pop, continent, lifeExp, gdpPercap)
names(gap_normal)</code></pre></li>
</ul></li>
<li>Let's see if they're equal. Not so good, they're sorted differently
<ul>
<li><p><span></span></p>
<pre><code>all_equal(gap_normal, gap)
head(gap_normal)
head(gap)</code></pre></li>
</ul></li>
<li>The new dataset is sorted first by continent, gap was by country
<ul>
<li><p><span></span></p>
<pre><code>gap_normal &lt;- gap_normal %&gt;% 
    arrange(country, continent, year)

all.equal(gap_normal, gap)
head(gap_normal)
head(gap)</code></pre></li>
<li>Arrange is a dplyr function</li>
<li><p>Defensive programming: It's a good idea to do checks all the time (like all_equal)</p></li>
</ul></li>
<li>Ok, now let's go back to wide</li>
<li>Remember, we used gather() to put all the columns together, and then separate() to split the year from the variable</li>
<li>So we just have to do the opposite in reverse order
<ul>
<li><p><span></span></p>
<pre><code>gap_wide_new &lt;- gap_long %&gt;% 
    unite(var_names, obs_type, year, sep = &quot;_&quot;) %&gt;%
    spread(var_names, obs_values)
str(gap_wide_new)</code></pre></li>
</ul></li>
<li>Just like dplyr, tidyr is nice because it's only a few functions
<ul>
<li>We can go from wide to long and back, and combine or split columns with 4 functions
<ul>
<li><code>gather(), spread(), separate(), unite()</code></li>
</ul></li>
</ul></li>
</ul>
<h3 id="resources">Resources:</h3>
<ul>
<li>Rstudio cheatsheets: <a href="https://www.rstudio.com/resources/cheatsheets/" class="uri">https://www.rstudio.com/resources/cheatsheets/</a></li>
<li>Package documentation: <a href="https://rdrr.io/cran/dplyr/" class="uri">https://rdrr.io/cran/dplyr/</a>, <a href="https://rdrr.io/cran/tidyr/" class="uri">https://rdrr.io/cran/tidyr/</a></li>
<li>R Cookbook: <a href="http://www.cookbook-r.com/Manipulating_data/" class="uri">http://www.cookbook-r.com/Manipulating_data/</a></li>
<li>Data Wrangling Webinar: <a href="https://www.rstudio.com/resources/webinars/data-wrangling-with-r-and-rstudio/" class="uri">https://www.rstudio.com/resources/webinars/data-wrangling-with-r-and-rstudio/</a></li>
</ul>
<h2 id="plotting-and-creating-publication-quality-graphics-60-minutes">5. Plotting and creating publication-quality graphics (60 minutes)</h2>
<ul>
<li>Now we're going to switch gears!</li>
<li>We have a grasp of basic programming in R</li>
<li>Most of our work here is 3 things: data wrangling, graphs, and analyses</li>
<li>We'll cover the first two, since the same stuff applies to everyone</li>
</ul>
<p><strong>Question: How many of you have made a plot in R? How many of you have used ggplot?</strong></p>
<ul>
<li>R has a few different ways to plot things.<br />
</li>
<li>It comes with a basic plotting package, but most people don't use this anymore, it's harder to modify
<ul>
<li><code>plot(x = gap$gdpPercap, y = gap$lifeExp)</code></li>
</ul></li>
<li>Show how to zoom a graph in Rstudio</li>
<li>A better option is ggplot2, which is more flexible, build plots in layers (kinda like photoshop)
<ul>
<li><code>install.packages(c(&quot;tidyr&quot;, &quot;dplyr&quot;, &quot;knitr&quot;, &quot;rmarkdown&quot;, &quot;formatR&quot;))</code></li>
<li><code>library(ggplot2)</code></li>
</ul></li>
<li>Grammar of graphics: Every plot is a dataset, a coordinate system, and a set of layers that are the visual representation
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp)) +
    geom_point()</code></pre></li>
</ul></li>
<li>First we load ggplot2</li>
<li>Then we call ggplot, all the options in here apply to all layers (aes maps the data)
<ul>
<li>ggplot is smart enough to look for those columns in the data we gave it, no need to subset</li>
<li>If we stop here we don't get a graph</li>
<li><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp))</code></li>
<li>So finally, we add a points (scatterplot) layer called a geometry</li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #1 ----------</em></strong>: Modify a ggplot graph</p>
<ul>
<li><p><code>ggplot(data = gap, aes(x=year, y=lifeExp)) + geom_point()</code></p></li>
<li>Using a scatterplot probably isn't a good way to show change over time.
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = year, y = lifeExp, 
    by = country, color = continent)) +
    geom_line()</code></pre></li>
</ul></li>
<li>We're using a line geometry instead of a points geometry now</li>
<li>the <strong>by</strong> aesthetic draws a line for each country, and then we color each continent differently.</li>
<li><strong>Question: What if we wanted the points on the graph too?</strong>
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = year, y = lifeExp, 
    by = country, color = continent)) +
    geom_line() + 
    geom_point()</code></pre></li>
</ul></li>
<li>Layers get drawn on top of each other
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = year, y = lifeExp, by = country)) +
    geom_line(aes(color = continent)) + 
    geom_point()</code></pre></li>
</ul></li>
<li>Here we've switched the color aesthetic from global to just the lines</li>
<li>If we want to set everything on a geometry to the same color, we set it outside the aesthetic function
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = year, y = lifeExp, by = country)) +
    geom_line(aes(color = continent)) + 
    geom_point(color = &quot;blue&quot;)</code></pre></li>
</ul></li>
<li>Let's go back to our first example, but color the points by continent
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp, color = continent)) +
    geom_point()</code></pre></li>
</ul></li>
<li>Hard to see relationship with all those outliers, so let's use a log scale
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp)) +
    geom_point(alpha = 0.5) + 
    scale_x_log10()</code></pre></li>
</ul></li>
<li>Notice the data has been transformed before graphing, x axis reflects this (1,000, 10,000, 100,000)</li>
<li><p>Here we also use transparency so that overlapping points are easier to see. This works with any geometry. We could also set this to use a data column inside aes()</p></li>
<li>We can fit a simple linear regression line (linear model) using a geom_smooth geometry
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp)) +
    geom_point() + scale_x_log10() + geom_smooth(method=&quot;lm&quot;)</code></pre></li>
</ul></li>
<li>It even gives us a confidence interval! We can make the line thicker using size
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp)) +
    geom_point() + scale_x_log10() + geom_smooth(method=&quot;lm&quot;, size=1.5)</code></pre></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #2 ----------</em></strong>: Color by continent &amp; add separate trends</p>
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp, color = continent)) +
    geom_point(size = 1.5) +
    scale_x_log10() +
    geom_smooth(method=&quot;lm&quot;)</code></pre></li>
<li>Many peope are colorblind. In addition to color, it's a good idea to also use shape
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp, color = continent)) +
    geom_point(size = 2, aes(shape = continent)) + 
    scale_x_log10() + 
    geom_smooth(method=&quot;lm&quot;)</code></pre></li>
</ul></li>
<li>Let's clean it up for publication. We'll add nicer axis labels, a title, and change the y-axis and theme
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = gdpPercap, y = lifeExp, color = continent)) +
    geom_point(size = 2, aes(shape = continent)) + 
    scale_x_log10() + 
    geom_smooth(method=&quot;lm&quot;) + 
    scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) + 
    theme_bw() + 
    labs(title = &quot;Effects of per-capita GDP on Life Expectancy&quot;, 
         x = &quot;GDP per Capita ($)&quot;, 
         y = &quot;Life Expectancy (yrs)&quot;, 
         color = &quot;Continents&quot;, 
         shape = &quot;Continents&quot;)</code></pre></li>
</ul></li>
<li>Now we have this graph, but we want to save it!
<ul>
<li>Rstudio has an export button: pdf, image, or to clipboard, lets you change size
<ul>
<li>The problem with this is that it's not reproducible. You fiddle with the size, but then months from now you need to change something</li>
</ul></li>
<li>Better to do it programmatically
<ul>
<li><code>ggsave(file = &quot;life_expectancy.png&quot;)</code></li>
<li><code>ggsave(file = &quot;life_expectancy.pdf&quot;)</code></li>
</ul></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative #3 ----------</em></strong>: Optional ggsave &amp; ggplot variables - ggsave will overwrite the graph</p>
<h3 id="facets-if-time-permits">Facets (if time permits)</h3>
<ul>
<li><p><span></span></p>
<pre><code>
ggplot(data = gap, aes(x = gdpPercap, y = lifeExp, color = continent)) + 
    facet_wrap(~ year) + 
    geom_point(size = 2, aes(shape = continent)) + 
    scale_x_log10() +
    geom_smooth(method = &quot;lm&quot;)</code></pre></li>
</ul>
<h3 id="alternate-facets-with-dplyr-if-time-permits">Alternate: Facets with dplyr (if time permits)</h3>
<ul>
<li><p><span></span></p>
<pre><code>L.countries &lt;- gap %&gt;% 
    filter(country %in% c(&quot;Lebanon&quot;, &quot;Lesotho&quot;, &quot;Liberia&quot;, &quot;Libya&quot;))

L.countries

ggplot(L.countries, aes(x = year, y = lifeExp, color = country)) + 
    geom_line() + facet_wrap( ~ country)</code></pre></li>
<li><p>Draws a panel for each unique value in that column</p></li>
</ul>
<h3 id="ggplot2-challenge-2-write-a-function-that-takes-vector-of-countries-creates-faceted-graph">GGplot2 Challenge #2: write a function that takes vector of countries &amp; creates faceted graph</h3>
<ul>
<li><p><span></span></p>
<pre><code>lifeExp_country &lt;- function(data, countries) {
     country_subset &lt;- data %&gt;%
          filter(country %in% countries)
     ggplot(country_subset, aes(x = year, y = lifeExp, color = country)) + 
          geom_line() + facet_wrap( ~ country)
}

lifeExp_country(gap, c(&quot;Ethiopia&quot;, &quot;Australia&quot;, &quot;Canada&quot;))</code></pre></li>
<li>Cover cowplot:
<ul>
<li><code>library(cowplot)</code></li>
<li>Nicer quality than default ggplot, it's a theme</li>
<li>Also provides a way to merge two plots into one, eg A &amp; B figures, and annotations</li>
</ul></li>
<li>Themes
<ul>
<li><p>Text size</p>
<ul>
<li><p><span></span></p>
<pre><code>theme(
    # Text size for axis ticks
    axis.text.y = element_text(size = 14),
    axis.text.x = element_text(size = 14),

    # Text size for axis labels
    # Also move them away from the axes a bit for more space
    axis.title.x = element_text(size = 18, face = &quot;bold&quot;, vjust = -1),
    axis.title.y = element_text(size = 18, face = &quot;bold&quot;, vjust = 1.5),

    # Plot title size, move away from plot
    plot.title = element_text(size = 20, face = &quot;bold&quot;, vjust = 5)
    )</code></pre></li>
</ul></li>
<li><p>Adjust the legend</p>
<ul>
<li><p><span></span></p>
<pre><code>theme(
    # Text size
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 16, face = &quot;bold&quot;),

    # Position
    legend.position = c(x = 0.8, y = 0.2)
    )</code></pre></li>
</ul></li>
</ul></li>
</ul>
<h3 id="ggplot2-challenge-2">GGplot2 Challenge #2:</h3>
<ul>
<li><p>Create a boxplot showing the spread of life expectancy for each continent</p>
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = continent, y = lifeExp)) + 
   geom_boxplot() + 
   geom_jitter(width = 0.2, alpha = 0.5, color = &quot;tomato&quot;)

ggplot(data = gap, aes(x = continent, y = lifeExp)) + 
    geom_boxplot() + 
    geom_jitter(width = 0.2, alpha = 0.5, size = 2, 
        aes(color = factor(year)))</code></pre></li>
</ul></li>
</ul>
<h3 id="ggplot2-challenge-3">GGplot2 Challenge #3:</h3>
<ul>
<li><p>Create a grouped barplot showing life expectancy by year for each continent</p>
<ul>
<li><p><span></span></p>
<pre><code>ggplot(data = gap, aes(x = continent)) + 
    geom_bar()

ggplot(data = gap, aes(x = continent, y = lifeExp, fill = factor(year))) + 
    geom_bar(stat = &quot;summary&quot;, fun.y = &quot;mean&quot;, position = &quot;dodge&quot;)</code></pre></li>
</ul></li>
</ul>
<h3 id="resources-1">Resources</h3>
<ul>
<li>R Graph catalog: <a href="http://shiny.stat.ubc.ca/r-graph-catalog/" class="uri">http://shiny.stat.ubc.ca/r-graph-catalog/</a></li>
<li>GGPlot2 online help: <a href="">http://docs.ggplot2.org/</a></li>
<li>R Graph Cookbook: <a href="http://www.cookbook-r.com/Graphs/" class="uri">http://www.cookbook-r.com/Graphs/</a></li>
<li>ggplot2 essentials: <a href="http://www.sthda.com/english/wiki/ggplot2-essentials" class="uri">http://www.sthda.com/english/wiki/ggplot2-essentials</a></li>
<li>Rstudio cheatsheets: <a href="https://www.rstudio.com/resources/cheatsheets/" class="uri">https://www.rstudio.com/resources/cheatsheets/</a></li>
<li>Cowplot: <a href="https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html" class="uri">https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html</a></li>
</ul>
<h2 id="producing-reports-and-notebooks-with-knitr-20-minutes">6. Producing reports and notebooks with knitr (20 minutes)</h2>
<p><strong>Question: How many of you could just send your code to your advisor or collaborator?</strong></p>
<ul>
<li>We often need to put this stuff in a presentable format: word, powerpoint, email, etc.</li>
<li>Then we need to change a graph, and update our presentation</li>
<li>We can do this all in one step, with less work by having R handle it. It's also easier to reproduce.</li>
<li>We'll do this with an R notebook, which will give us a single html file with all the code, data, graphs, and our notes. We can upload this online, show it as a presentation, or send it to someone.<br />
</li>
<li><p>Basically a fancy lab notebook!</p></li>
<li>Create a new R notebook and save it.
<ul>
<li>Talk about the header chunk</li>
<li>Explain code chunks
<ul>
<li>Run the graph code</li>
<li>Add a new chunk with <code>head(cars, 30)</code> and run it</li>
<li>Show how to switch between inline and console, explain inline usefulness</li>
</ul></li>
<li>Click preview to see the html</li>
<li>Show where the file is saved</li>
</ul></li>
<li>Notice how we got some nice formatted text. This is using something called markdown
<ul>
<li><a href="http://rmarkdown.rstudio.com" class="uri">http://rmarkdown.rstudio.com</a></li>
<li>Demo
<ul>
<li>headings <code>### Heading</code></li>
<li>bullets <code>* Bullet or - Bullet</code></li>
<li>numbered lists <code>1. list</code></li>
<li>bold <code>**bold**</code></li>
<li>italic <code>*italic*</code></li>
<li>links <code>[Software Carpentry](http://software-carpentry.org/)</code></li>
</ul></li>
</ul></li>
</ul>
<p><strong><em>---------- Socrative ----------</em></strong>: R Notebook Challenge</p>
<p>Modify your R notebook to load the data from gap, show the first 10 lines, and display a graph.<br />
Give each R code section a heading and short summary. - <span></span></p>
<pre><code>    ```
    ## Reading &amp; Displaying Data

    This chunk reads in the gap dataset and shows the first 10 lines

    ``{r}
    gap &lt;- read.csv(&quot;data/gapminder-data.csv&quot;)
    head(gap, 10)
    ``

    ## Graph Gap Dataset

    This chunk shows a graph

    ``{r}
    library(ggplot2)
    ggplot(data = gap, aes(x = gdpPercap, y = lifeExp)) + 
      geom_point()
    ``
    ```</code></pre>
<ul>
<li>Variables are shared between chunks
<ul>
<li>Add a variable to a chunk and print it in another</li>
</ul></li>
<li>You could also knit to a word file instead. Or pdf, though this requires some extra setup</li>
<li>You can publish stuff to the internet, and run code from other languages, eg bash shell and python.</li>
<li><p>There's a format to publish reports to github</p>
<ul>
<li><p><span></span></p>
<pre><code>github_document:
    toc: yes
    toc_depth: 5</code></pre></li>
<li><p>You can name chunks, and control output for graphs</p></li>
<li><p><span></span></p>
<pre><code>{r &quot;test_graph&quot;, fig.height = 6, fig.width = 8, dpi = 300}</code></pre></li>
</ul></li>
</ul>
<h2 id="writing-good-software-5-minutes">7. Writing good software (5 Minutes)</h2>
<ul>
<li>It's really easy to be in a hurry and just quickly write the code for a graph or an analysis with no commentary on how the code works or the results you got!
<ul>
<li>This will come back to bite you!</li>
<li>You'll end up re-spending hours trying remember how something works.</li>
</ul></li>
<li>Readable code is super important!
<ul>
<li>We often collaborate</li>
<li>We often do analyses and then come back a year later (when writing thesis)</li>
</ul></li>
<li>Rules of thumb
<ul>
<li>Indent code inside loops, functions, and if statements</li>
<li>Use good variable &amp; function names and don't overwrite variables</li>
<li>Use lots of comments to explain what lines of code do</li>
<li>There's an R style guide: <a href="http://style.tidyverse.org" class="uri">http://style.tidyverse.org</a>
<ul>
<li>Preferences &gt; Code &gt; Diagnostics, gives you tiny warnings to enforce</li>
</ul></li>
</ul></li>
<li>Break down problems into bite-sized pieces and keep things modular
<ul>
<li>e.g. using functions, or even separate files.<br />
</li>
<li>I like to have an R script to get my data from csv ready for analysis
<ul>
<li>Then I can just pull this in to different analyses I do.</li>
</ul></li>
</ul></li>
<li>Don't repeat yourself!
<ul>
<li>Re-use code, build functions, use loops</li>
</ul></li>
<li>Always be thinking of ways your code might break
<ul>
<li>Anticipate those failures and leave messages to yourself with if statements</li>
<li>Test your functions over different inputs to make sure they always work.</li>
</ul></li>
<li>I like to print out <code>sessionInfo()</code> in my R Notebooks so I know what package versions I used
<ul>
<li>Mention <code>packrat</code></li>
</ul></li>
</ul>
<h2 id="using-git-from-rstudio-15-minutes">8. Using Git from RStudio (15 minutes)</h2>
<ul>
<li>Setup RStudio to use git
<ul>
<li>In RStudio, click on Tools &gt; Global Options... &gt; Git/SVN</li>
<li>Make sure there's a git executable listed there. If not, browse for it, or ask for help</li>
<li>Make sure the grey box under &quot;SSH RSA Key&quot; shows a file name and a &quot;View public key&quot; link exists next to it.
<ul>
<li>Clicking on &quot;View public key&quot; opens a window opens which is not blank.<br />
</li>
</ul></li>
<li>If the &quot;SSH RSA Key&quot; box is blank, click &quot;Create RSA key...&quot; and leave the optional Passphrase blank and click &quot;Create&quot;.</li>
</ul></li>
<li>Setup the Project with a git repository
<ul>
<li>Go to Tools &gt; Project Options &gt; Git/SVN</li>
<li>Set version control system to Git, and allow RStudio to initialize repository</li>
</ul></li>
<li>Now we have a git tab: Explore the interface
<ul>
<li>Check the boxes on some files (<strong>stage</strong>)</li>
<li>Commit, and add a message. Notice it shows a diff</li>
<li>Make some changes to a file and save</li>
<li>Show how to diff and how to revert</li>
<li>Click the history button to see the history</li>
</ul></li>
<li>Syncing with GitHub
<ul>
<li>We have push and pull buttons, but they're grayed out</li>
<li>To enable them, we need to add a remote</li>
<li><p>Go to Tools &gt; Terminal &gt; New Terminal or Git &gt; Gear &gt; Shell</p></li>
<li><p><span></span></p>
<pre><code>git remote add origin https://github.com/mickley/rstudio-test.git
git push -u origin master</code></pre></li>
</ul></li>
</ul>
</body>
</html>
